# SecuredServices (черновик)
## Entities

**IEntityProtector** - производит проверку объекта, используя роли доступа (Policy)

**IManagerSession** - пользователь, вносящий изменения в объект, который необходимо защитить. Имеет роль доступа

1. Знать, кто вносит изменения
2. Узнать, какие права нужны для внесения изменений
3. **Узнать, какие права есть у того, кто в носит изменения**
4. Проверить, что хочет изменить пользователь
5. Узнать, можно ли было вносить текущие изменения
6. Сломать колени / Одобрить

```C#
// current user can change group with id = 5
var currentContext = HttpContext;
var policies = new PolicyProvider(typeof(GroupRoles));
var groupService = new GroupService(id: 1); // can't use

var serviceProtector = new ServiceProtector<GroupsService>(currentContext, policies);
if(serviceProtector.CanAddChanges(groupService))
{
    var group = groupService.Current.Title = "Changed Title";
    groupService.SaveChanges(group);
}
else
{
    Log.Information("Current user can't be add changes in group (id = 1)");
}
```

## Идея

Есть 3 обособленных звена, которые могут функционировать по отдельности

1 звено. Получает минимальную информацию о персоне, которой будет достаточно для определения уровня доступа к **защищенному объекту**

2 звено. Защищенный объект - объект, к которому нужно перекрыть доступ определенным пользователям.

3 звено. Определение доступности. Берет уровень доступа текущего пользователя из **сессии**, получает защищенный объект и определяет, к какой информации текущий пользователь имеет доступ и выдает результат

Все три звена могут быть объеденены в одном контейнере - EntityProtector. Он знает кто и к чему хочет получить доступ. А благодаря зарегистрированным обработчикам (звено 3) может правильно (в зависимости от задачи) сделать выводы. 

### Как работает EntityProtector

1. Получает в метод **IsProtected** два объекта: измененный и шаблонный (который был до изменения)
2. Определяет, какие свойства должны быть защищены (помечены аттрибутами ChangeProtectionAttribute)
3. Запускает обработчиков (по умолчанию метод IsChangeVerified), но по хорошему нужно сделать **ProtectProcessor**
4. 
